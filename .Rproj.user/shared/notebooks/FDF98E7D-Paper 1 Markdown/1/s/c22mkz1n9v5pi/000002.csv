"0",""
"0","#### this routine summarises all the information about each bout - how many elements, players etc. Can be used to select only dyadic bouts"
"0","bout.summary <- lapply(unique(video.data$bout.nr), function(x) {"
"0","  set.data <- filter(video.data, bout.nr == x, !Behavior %in% c(""Non-Play"", ""Comment"", ""Start""))"
"0","  set.data <- set.data[order(set.data$Time), ]"
"0","  if (nrow(set.data) == 0) {"
"0","    return()"
"0","  }"
"0","  xx <- data.frame("
"0","    bout.nr = x,"
"0","    video.id = unique(set.data$Media_file_path),"
"0","    players = paste(sort(unique(unlist(strsplit(set.data$Modifier_1[set.data$Behavior == ""Players""], split = "","", fixed = T)))), collapse = "",""),"
"0","    initiator = set.data$Subject[min(which(set.data$Behavior == ""Play Element""))],"
"0","    nr.players = length(sort(unique(unlist(strsplit(set.data$Modifier_1[set.data$Behavior == ""Players""], split = "","", fixed = T))))),"
"0","    start.observed = set.data$Modifier_2[1],"
"0","    start.time = set.data$Time[2],"
"0","    end.time = max(set.data$Time[set.data$Behavior == ""End""]),"
"0","    duration = set.data$Time[nrow(set.data)] - set.data$Time[2],"
"0","    play.elements = sum(set.data$Behavior == ""Play Element""),"
"0","    end = as.numeric(""End"" %in% set.data$Behavior),"
"0","    intervention = as.numeric(""Intervention"" %in% set.data$Behavior)"
"0","  )"
"0","  xx$end.observed <- NA"
"0","  xx$end.outcome <- NA"
"0","  if (xx$end == 1) {"
"0","    xx$end.observed <- set.data$Modifier_2[which(set.data$Behavior == ""End"")][length(set.data$Modifier_2[which(set.data$Behavior == ""End"")])]"
"0","  }"
"0","  if (xx$end == 1) {"
"0","    xx$end.outcome <- set.data$Modifier_1[which(set.data$Behavior == ""End"")][length(set.data$Modifier_1[which(set.data$Behavior == ""End"")])]"
"0","  }"
"0","  if (xx$start.observed == ""No"") {"
"0","    xx$initiator <- NA"
"0","  }"
"0","  return(xx)"
"0","})"
"0","bout.summary <- do.call(rbind, bout.summary)"
"0",""
"0","#### load all element codes from the BORIS folder"
"0","elements <- sort(as.vector(unlist(c("
"0","  read.csv(""C:/Users/Alex/Documents/GitHub/CCCPP/Coding/BORIS modifiers/contact_extended.txt"", header = F),"
"0","  read.csv(""C:/Users/Alex/Documents/GitHub/CCCPP/Coding/BORIS modifiers/contact_short.txt"", header = F),"
"0","  read.csv(""C:/Users/Alex/Documents/GitHub/CCCPP/Coding/BORIS modifiers/noncontact_extended.txt"", header = F),"
"0","  read.csv(""C:/Users/Alex/Documents/GitHub/CCCPP/Coding/BORIS modifiers/noncontact_short.txt"", header = F),"
"0","  read.csv(""C:/Users/Alex/Documents/GitHub/CCCPP/Coding/BORIS modifiers/social object.txt"", header = F),"
"0","  ""Break"""
"0","))))"
"0","elements <- elements[elements != ""Ignore""]"
"0","elements <- elements[elements != ""Break""]"
"0",""
"0","### cleanly extract element sequences for each individual in each bout"
"0","bout.data <- lapply(unique(video.data$bout.nr), function(x) {"
"0","  set.data <- filter(video.data, bout.nr == x, !Behavior %in% c(""Non-Play"", ""Comment"", ""Start"", ""End"", ""Players"", ""Intervention""))"
"0","  set.data <- set.data[order(set.data$Subject), ]"
"0","  focal <- set.data$Subject"
"0","  bout.nr <- set.data$bout.nr"
"0","  Time <- set.data$Time"
"0","  bout.elements <- list()"
"0","  for (i in 1:nrow(set.data)) {"
"0","    yy <- as.vector(unlist(strsplit(unlist(set.data[i, ]), split = "","", fixed = T)))"
"0","    yy <- intersect(yy, elements)"
"0","    if (length(yy) > 1 & i > 1) { # Remove Bipedal, retreat, flee if it happens continuously"
"0","      if (""Bipedal"" %in% bout.elements[[i - 1]]) {"
"0","        yy <- yy[yy != ""Bipedal""]"
"0","      }"
"0","      if (""Retreat"" %in% bout.elements[[i - 1]]) {"
"0","        yy <- yy[yy != ""Retreat""]"
"0","      }"
"0","      if (""Retreat-backwards"" %in% bout.elements[[i - 1]]) {"
"0","        yy <- yy[yy != ""Retreat-backwards""]"
"0","      }"
"0","      if (""Flee"" %in% bout.elements[[i - 1]]) {"
"0","        yy <- yy[yy != ""Flee""]"
"0","      }"
"0","      if (""Bend-sapling"" %in% bout.elements[[i - 1]]) {"
"0","        yy <- yy[yy != ""Bend-sapling""]"
"0","      }"
"0","      if (""Hold"" %in% bout.elements[[i - 1]]) {"
"0","        yy <- yy[yy != ""Hold""]"
"0","      }"
"0","    }"
"0","    bout.elements[[i]] <- yy"
"0","  }"
"0","  bout.elements <- sapply(bout.elements, paste, collapse = ""%"")"
"0","  bout.elements[bout.elements == """"] <- NA"
"0","  return(data.frame(focal, bout.nr, Time, bout.elements))"
"0","})"
"0",""
"0",""
"0","bout.data <- do.call(rbind, bout.data)"
"0","bout.data$bout.nr <- bout.data %>%"
"0","  unite(bout.nr, bout.nr, focal, sep = ""_"", remove = T) %>%"
"0","  select(bout.nr)"
"0","bout.data$bout.nr <- as.vector(bout.data$bout.nr$bout.nr)"
"0",""
"0","elements.bout <- lapply(unique(bout.data$bout.nr), function(x) {"
"0","  set.data <- filter(bout.data, bout.nr == x)"
"0","  return(set.data$bout.elements)"
"0","})"
"0",""
"0","elements.time <- lapply(unique(bout.data$bout.nr), function(x) {"
"0","  set.data <- filter(bout.data, bout.nr == x)"
"0","  return(set.data$Time)"
"0","})"
"0",""
"0","names(elements.bout) <- unique(bout.data$bout.nr)"
"0",""
